<task id="TASK-0068">
<summary>Stop cascading DISCOVERY_READ_FAIL from synthetic include paths</summary>
<scope>
- Components: discovery.collect_contents, include edge recording, diagnostic deduplication
- Scenario: BusyBox kbuild lines currently spawn READ_FAIL for tokens like $(wildcard, $(srctree)/*/*.c), pipe symbols, and other non-files
</scope>
<developer>
- Prevent collect_contents from attempting to read nodes that failed existence checks during include scanning; gate edge creation or mark nodes as virtual so they are skipped.
- Add normalization/validation to drop tokens containing shell metacharacters (|, *, $() without concrete resolution) before enqueueing them for reading.
- Deduplicate READ_FAIL diagnostics for the same path and avoid double-reporting alongside INCLUDE_MISSING.
- Consider downgrading READ_FAIL to WARN for clearly non-file tokens while keeping true IO errors as ERROR.
- Update diagnostic payloads with origin include line to improve traceability.
</developer>
<qe>
- Add regression asserting READ_FAIL is not emitted (or is downgraded) for kbuild wildcard prerequisites while real IO errors still surface.
- Verify collect_contents skips invalid nodes yet continues processing valid includes.
- Ensure deduplication works when the same bad token appears multiple times.
</qe>
<reviewer>
- Confirm separation between missing include handling and read failures is clear.
- Check that skipping invalid nodes does not hide legitimate filesystem issues.
- Ensure new behavior remains deterministic with sorted traversal.
</reviewer>
<tests>
- pytest tests/discovery/test_real_world_regressions.py::test_kbuild_autoconf_rule_misparsed_and_read_fails
- pytest -k discovery and read_fail
</tests>
</task>
