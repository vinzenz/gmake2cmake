<task id="TASK-0002">
<summary>Implement MakefileDiscoverer, MakefileParser, and MakeEvaluator to produce BuildFacts with diagnostics, including project-global config detection.</summary>
<scope>
- Components: discovery, parser, evaluator; integrate with CLIController run() to execute full pipeline up to BuildFacts (IRBuilder stub allowed).
- Add AST dataclasses, variable env, compile inference heuristics, and global config extraction (config.mk/rules.mk/defs.mk and top-level assignments before first rule categorized as ProjectGlobals).</scope>
<developer>
- Implement functions per specs with deterministic ordering and posix paths.
- Extend CLIController wiring to create diagnostics collector, config loading, discovery->parse->evaluate; IRBuilder placeholder returning empty Project allowed but maintain interface.
- Build test fixtures for Makefiles covering includes, pattern rules, conditionals, custom commands, global config files/blocks.</developer>
<qe>
- Pytest cases for: missing entry (ERROR), include cycles, optional include WARN, line continuations, nested conditionals, autovar expansion, compile inference (C/C++/ASM), unsupported function WARN, ignored paths respected, project-global config extraction from config.mk/rules.mk/defs.mk and pre-rule assignments.
- Integration tests hitting CLI run() with fake fs for scenarios TS01-TS12, TS16-TS18, TS21 (global config detection).</qe>
<reviewer>
- Verify parser/evaluator purity (no fs writes), correct SourceLocation population, deterministic BuildFacts ordering.
- Check diagnostics codes correctness and non-fatal behavior.
- Ensure ignored paths prevent fact creation and diagnostics emitted appropriately; global config stored in BuildFacts.project_globals with provenance.</reviewer>
<tests>
- Commands: `ruff check . && pytest -q tests/parser tests/evaluator tests/integration_cli`.
- Scenario coverage: TS02, TS03, TS04, TS05, TS06, TS11, TS12, TS16, TS17, TS18, TS21.</tests>
</task>
