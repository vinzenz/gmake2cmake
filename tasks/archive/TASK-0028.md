<task id="TASK-0028">
<summary>Implement recursive variable loop detection.</summary>
<scope>
- Add comprehensive loop detection in MakeEvaluator.expand_variables.
- Track variable expansion stack to detect circular references.
- Handle both direct (A=$(B), B=$(A)) and indirect loops.
- Emit clear ERROR diagnostic EVAL_RECURSIVE_LOOP with loop path.
- Implement safe fallback values to allow continued evaluation.</scope>
<developer>
- Maintain expansion_stack in VariableEnv tracking active expansions.
- Check for revisiting variables during recursive expansion.
- Collect full loop path for diagnostic message.
- Use placeholder value like <recursive:VAR> when loop detected.
- Add max recursion depth limit for runaway expansions.</developer>
<qe>
- Test direct two-variable loops.
- Test complex multi-variable circular references.
- Test mixed simple/recursive variable loops.
- Verify clear diagnostic messages with loop paths.
- Test evaluation continues after loop detection.</qe>
<reviewer>
- Check loop detection doesn't false-positive on valid recursion.
- Verify performance impact acceptable.
- Ensure diagnostic messages help users fix issues.
- Validate placeholder values don't break downstream processing.</reviewer>
<tests>
- Commands: `pytest -q tests/evaluator/test_recursive_loops.py`.</tests>
</task>