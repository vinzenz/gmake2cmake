<task id="TASK-0069">
<summary>Harden recursive make parsing to avoid false DISCOVERY_SUBDIR_MISSING</summary>
<scope>
- Components: discovery.scan_includes recursive -C parsing
- Scenario: Git shared.mak sets QUIET_SUBDIR0 = +$(MAKE) -C # comment and QUIET_SUBDIR1 with $$subdir, producing bogus paths like #/Makefile and $$subdir/Makefile
</scope>
<developer>
- Strip comments after -C and ignore empty/placeholder directory arguments when extracting recursive targets.
- Handle $$var and $(@D) style variables by skipping or normalizing them rather than treating them as literal directories.
- Add safeguards to avoid emitting multiple SUBDIR_MISSING warnings when the same placeholder repeats.
- Keep existing behavior for concrete -C paths intact, including deterministic edge ordering.
</developer>
<qe>
- Add regression for QUIET_SUBDIR0 comment and $$subdir assignments to ensure they no longer emit SUBDIR_MISSING for placeholders.
- Validate genuine missing subdir makefiles still warn and are traced to the correct line numbers.
- Run existing recursive make cycle/missing tests to confirm no regressions.
</qe>
<reviewer>
- Check parsing logic for comments/variables is robust and does not under-report real missing subdirs.
- Ensure diagnostic deduplication and ordering remain stable.
- Verify documentation of supported -C forms is updated if changed.
</reviewer>
<tests>
- pytest tests/discovery/test_real_world_regressions.py::test_make_dash_c_comment_triggers_subdir_missing_warning
- pytest tests/discovery/test_recursive_make.py
- pytest -k subdir_missing
</tests>
</task>
