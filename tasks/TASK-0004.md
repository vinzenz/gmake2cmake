<task id="TASK-0004">
<summary>Strengthen IRBuilder: internal/external/imported classification, usage requirements, deps attachment.</summary>
<scope>
- Enhance IRBuilder to classify libraries using build facts, tree location, and ConfigModel.link_overrides.
- Propagate PUBLIC/PRIVATE/INTERFACE usage for includes/defines/options; ensure deps use aliases for internal libs.
- Attach dependencies from rule prerequisites; validate references.</scope>
<developer>
- Extend BuildFacts/IRBuilder logic to mark internals (build artefacts in tree) vs externals/imported per override.
- Implement usage requirement mapping when applying target mappings; normalize include/define/option aggregation.
- Attach deps from EvaluatedRule prerequisites to target.deps (alias-preferring); ensure deterministic ordering.</developer>
<qe>
- Add pytest cases under tests/ir covering internal vs external/imported overrides, alias usage in deps, visibility propagation, duplicate detection.
- Include regression for IR_UNKNOWN_DEP and IR_DUP_ALIAS/IR_DUP_TARGET handling.</qe>
<reviewer>
- Verify classification heuristics and override precedence; aliases used for internal links only.
- Check deterministic ordering and diagnostics coverage.</reviewer>
<tests>
- Commands: `ruff check . && pytest -q tests/ir`.
- Scenarios: TS22 (alias linking internal vs external), TS25 (global vs per-target flags/visibility), IR validation errors.</tests>
</task>
